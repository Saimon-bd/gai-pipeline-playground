name: terraform-cd

on:
  workflow_call:
    secrets:
      github-token:
        required: true
      azure-credentials-env:
        required: true
      azure-credentials-adb2c:
        required: false
      azure-shared-subscription-id:
        required: true
      slack-webhook-url-dev:
        required: false
      slack-webhook-url-stg:
        required: false
      slack-webhook-url-prd:
        required: false
    inputs:
      region:
        required: true
        type: string
      team:
        required: true
        type: string
      environment:
        required: true
        type: string
        description: 'JSON array of environments to deploy'
      terraform-version:
        required: true
        type: string
      paths:
        required: false
        type: string

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Fake Terraform Plan
        run: echo "‚úÖ Terraform plan completed (placeholder)"

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    strategy:
      matrix:
        environment: ${{ fromJson(inputs.environment) }}
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Slack - Waiting for Approval
        run: |
          echo "üîç Debug: Environment = ${{ matrix.environment }}"
          WEBHOOK_URL=""
          case "${{ matrix.environment }}" in
            "dev") WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_DEV }}" ;;
            "stg") WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_STG }}" ;;  
            "prd") WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL_PRD }}" ;;
          esac
          
          echo "üîç Debug: WEBHOOK_URL length = ${#WEBHOOK_URL}"
          
          if [ ! -z "$WEBHOOK_URL" ]; then
            echo "‚úÖ Sending Slack notification for ${{ matrix.environment }}"
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\":\"Waiting for APIM apply approval - ${{ matrix.environment }}\",
                \"blocks\":[
                  {
                    \"type\":\"section\",
                    \"text\":{
                      \"type\":\"mrkdwn\",
                      \"text\":\"*Environment:* ${{ matrix.environment }}\\n*Repository:* ${{ github.repository }}\\n*Triggered by:* ${{ github.actor }}\\n\\nWaiting for APIM apply approval.\"
                    }
                  },
                  {
                    \"type\":\"actions\",
                    \"elements\":[
                      {
                        \"type\":\"button\",
                        \"text\":{\"type\":\"plain_text\",\"text\":\"View Workflow\"},
                        \"url\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                      }
                    ]
                  }
                ]
              }" \
              "$WEBHOOK_URL"
            echo "‚úÖ Slack notification sent successfully"
          else
            echo "‚ùå No webhook URL found for environment: ${{ matrix.environment }}"
            echo "üí° Please add SLACK_WEBHOOK_URL_$(echo ${{ matrix.environment }} | tr '[:lower:]' '[:upper:]') secret"
          fi

      - name: Fake Terraform Apply
        run: echo "üöÄ Terraform apply completed for ${{ matrix.environment }} (placeholder)"
