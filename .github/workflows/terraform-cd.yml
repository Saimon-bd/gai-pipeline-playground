name: terraform-cd

on:
  workflow_call:
    secrets:
      github-token:
        required: true
      azure-credentials-env:
        required: true
      azure-credentials-adb2c:
        required: false
      azure-shared-subscription-id:
        required: true
    inputs:
      region:
        description: 'Region of the environment'
        required: true
        type: string
      team:
        required: true
        type: string
      paths:
        required: false
        type: string
      environment:
        required: true
        type: string
      terraform-version:
        required: true
        type: string

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on:
      group: linux-2core-${{ inputs.environment }}-${{ inputs.region }}-group
    strategy:
      matrix:
        # Parse JSON array containing names of all filters matching any of changed files
        path: ${{ fromJson(inputs.paths) }}
    env:
      TF_VAR_AZ_SHARED_SUBSCRIPTION_ID: ${{ secrets.AZ_SHARED_SUBSCRIPTION_ID }}
      AZ_SHARED_SUBSCRIPTION_ID: ${{ secrets.AZ_SHARED_SUBSCRIPTION_ID }}
    defaults:
      run:
        shell: bash
        working-directory: "environments/${{ matrix.path }}"

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Set Environment Variables
        uses: ./.github/workflows/azure-spn-secret-env
        with:
          creds-env: ${{ secrets.azure-credentials-env }}
          creds-adb2c: ${{ secrets.azure-credentials-adb2c }}
          environment: ${{ inputs.environment }}

      - name: Configure git token
        run: git config --global url."https://${{ secrets.github-token }}:@github.com/drivegreenlane/".insteadOf "https://github.com/drivegreenlane/"\

      # Parse directory path into a usable name for artifact - substitutes '/' per '-'
      - name: Get Service Name
        id: service
        run: | 
          path=${{ matrix.path }}
          echo "service_name=${path////-}" >> $GITHUB_ENV

  
  terraform-apply:
    name: Terraform Apply
    runs-on:
      group: linux-2core-${{ inputs.environment }}-${{ inputs.region }}-group
    needs: [terraform-plan]
    environment: ${{ inputs.environment }}
    strategy:
      matrix:
        # Parse JSON array containing names of all filters matching any of changed files
        path: ${{ fromJson(inputs.paths) }}
    defaults:
      run:
        shell: bash
        working-directory: environments/${{ matrix.path }}

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Set Environment Variables
        uses: ./.github/workflows/azure-spn-secret-env
        with:
          creds-env: ${{ secrets.azure-credentials-env }}
          creds-adb2c: ${{ secrets.azure-credentials-adb2c }}
          environment: ${{ inputs.environment }}

      - name: Configure git token
        run: git config --global url."https://${{ secrets.github-token }}:@github.com/drivegreenlane/".insteadOf "https://github.com/drivegreenlane/"\

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform-version }}

      - name: Terraform Init
        id: init
        run: terraform init -backend-config ${{ inputs.environment }}.backend.tfvars -upgrade

      # Parse directory path into a usable name for artifact - substitutes '/' per '-'
      - name: Get Service Name
        id: service
        run: |
          path=${{ matrix.path }}
          echo "service_name=${path////-}" >> $GITHUB_ENV

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.team }}-${{ env.service_name }}-${{ github.run_number }}
          path: environments/${{ matrix.path }}

      - name: Terraform Apply
        id: apply
        env:
          TF_VAR_AZ_SHARED_SUBSCRIPTION_ID: ${{ secrets.azure-shared-subscription-id }}
          AZ_SHARED_SUBSCRIPTION_ID: ${{ secrets.azure-shared-subscription-id }}
        run: terraform apply -auto-approve -input=false tfplan

      - name: Upload TrustFramework Policy
        if: contains(matrix.path, 'customer-service/ad-b2c')
        uses: azure-ad-b2c/deploy-trustframework-policy@v5
        with:
          folder: environments/${{ matrix.path }}/policies
          files: "TrustFrameworkBase.xml, TrustFrameworkLocalization.xml, TrustFrameworkExtensions.xml, SignUpOrSignin.xml, SignUp.xml, SignIn.xml"
          tenant: ${{ env.TF_VAR_GREENLANE_ADB2C_TENANT_ID }}
          clientId: ${{ env.TF_VAR_GREENLANE_ADB2C_CLIENT_ID }}
          clientSecret: ${{ env.TF_VAR_GREENLANE_ADB2C_CLIENT_SECRET }}
