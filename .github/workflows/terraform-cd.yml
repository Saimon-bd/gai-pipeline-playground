name: terraform-cd

on:
  workflow_call:
    inputs:
      region:
        required: false
        type: string
      team:
        required: false
        type: string
      paths:
        required: false
        type: string
      environment:
        required: true
        type: string
      terraform-version:
        required: false
        type: string

jobs:
  terraform-plan:
    name: Terraform Plan (simulated)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        path: ${{ fromJson(inputs.paths) }}
    defaults:
      run:
        shell: bash
        working-directory: "environments/${{ matrix.path }}"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fake Terraform Plan
        run: |
          echo "This is a placeholder for Terraform Plan."
          echo "Pretend we generated a plan for ${{ inputs.environment }} / ${{ matrix.path }}."
          echo "plan-content" > plan.txt

      - name: Get Service Name
        id: service
        run: |
          path=${{ matrix.path }}
          echo "service_name=${path////-}" >> $GITHUB_ENV

  slack-notification:
    name: Notify Slack
    if: success()
    needs: [terraform-plan]
    runs-on: ubuntu-latest
    steps:
      - name: Debug Inputs & Context
        run: |
          echo "================ DEBUG START ================"
          echo "üëâ GitHub Event Name        : ${{ github.event_name }}"
          echo "üëâ Workflow Input Environment: '${{ inputs.environment }}'"
          echo "üëâ Matrix paths             : ${{ inputs.paths }}"
          echo "üëâ Team                     : ${{ inputs.team }}"
          echo "üëâ Terraform Version        : ${{ inputs.terraform-version }}"
          echo "================= DEBUG END ================="

      - name: Set Slack Webhook
        id: slack
        run: |
          echo "url=${SLACK_WEBHOOK}" >> $GITHUB_OUTPUT
        env:
          SLACK_WEBHOOK: ${{ inputs.environment == 'dev' && secrets.SLACK_WEBHOOK_URL_DEV || inputs.environment == 'stg' && secrets.SLACK_WEBHOOK_URL_STG || secrets.SLACK_WEBHOOK_URL_PRD }}

      - name: Deep Debug Slack Variables
        run: |
          echo "================ SLACK DEBUG START ================"
          echo "üëâ inputs.environment   = '${{ inputs.environment }}'"
          echo "üëâ steps.slack.outputs.url (masked if secret) = '${{ steps.slack.outputs.url }}'"
          if [ -z "${SLACK_WEBHOOK}" ]; then
            echo "‚ùå SLACK_WEBHOOK env (in Set step) is EMPTY"
          else
            echo "‚úÖ SLACK_WEBHOOK env (in Set step) length: ${#SLACK_WEBHOOK}"
          fi
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "‚ùå SLACK_WEBHOOK_URL (from step output) is EMPTY"
          else
            echo "‚úÖ SLACK_WEBHOOK_URL (from step output) length: ${#SLACK_WEBHOOK_URL}"
          fi
          echo "================= SLACK DEBUG END ================="
        env:
          SLACK_WEBHOOK: ${{ inputs.environment == 'dev' && secrets.SLACK_WEBHOOK_URL_DEV || inputs.environment == 'stg' && secrets.SLACK_WEBHOOK_URL_STG || secrets.SLACK_WEBHOOK_URL_PRD }}
          SLACK_WEBHOOK_URL: ${{ steps.slack.outputs.url }}

      - name: Send notification to Slack
        run: |
          echo "üëâ Sending Slack notification..."
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\":rocket: Plan ready for *${{ inputs.environment }}*. Waiting for approval.\"}" \
            "${SLACK_WEBHOOK_URL}"
        env:
          SLACK_WEBHOOK_URL: ${{ steps.slack.outputs.url }}
          
  terraform-apply:
    name: Terraform Apply (approval only)
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    environment: ${{ inputs.environment }} # approval required
    strategy:
      matrix:
        path: ${{ fromJson(inputs.paths) }}
    defaults:
      run:
        shell: bash
        working-directory: environments/${{ matrix.path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Fake Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.team }}-${{ env.service_name }}-${{ github.run_number }}
          path: environments/${{ matrix.path }}

      - name: Simulate Apply
        run: |
          echo "Simulating apply for ${{ inputs.environment }} / ${{ matrix.path }}"
          cat plan.txt
          echo "Apply complete."
